"use strict";define(function(i,P,g){var s=i("../../js/util/tool");var u=i("cola");var A={};var I=i("../../js/util/debounce");var n,p,t,M,J,a,e,x,B={project:25,company:20,person:15},y={project:20,company:25,person:15},C=0.25,H=["项目","单位","人员"],c={project:"项目",company:"单位",person:"联系人"},z,d,f,l,R,k=false,j,v,o,D;
var N,w,U,T;var r=0;function O(Z,X,Y){var W=X.type;$.ajax({url:path+"/getRelationDetail",type:"POST",dataType:"json",data:{type:Z.type,id:Z.id},success:function(aa){G(W,aa,Y,X);
},error:function(aa){return"error";}});}function G(Y,aa,ad,ac){var Y=Y;var Z=this;var X={project:"#ff1d20",company:"#239deb",person:"#ff9a00"};var ab="";
if(Y==="person"){ab="联系人";}else{if(Y==="project"){ab="项目";}else{if(Y==="company"){ab="单位";}}}$(".tip_project").css("background",X[Y]);$(".tip_project .tipCon").html("");
$(".tip_project .tipTitle").html(ab).attr("title",aa.name);if(Y==="person"){var W=$("<ul></ul>").append('<li class="info">姓 名：'+aa.name+"</li>").append('<li class="more">了解更多</li>').appendTo($(".tip_project .tipCon"));
}else{if(Y==="company"){var W=$("<ul></ul>").append('<li class="info">单位名称：'+aa.name+"</li>").append('<li class="more">了解更多</li>').appendTo($(".tip_project.tipCon"));
}else{if(Y==="project"){var W=$("<ul></ul>").append('<li class="info">项目名称：'+aa.name+"</li>").append('<li class="more">了解更多</li>').appendTo($(".tipCon"));
}}}}function m(){if(k){return;}var W=d3.event.scale;R.attr("transform","translate("+d3.event.translate+") scale("+W+")");}function q(W){w.links.forEach(function(X){var Z=w.nodes[X.source],Y=w.nodes[X.target];
if(Z===W&&!b(Y)){L(Y,W);}if(Y===W&&!b(Z)){L(Z,W);}});U.links=[];w.links.forEach(function(X){var Z=w.nodes[X.source],Y=w.nodes[X.target];if(b(Z)&&b(Y)){U.links.push({source:Z,target:Y});
}});}function b(W){return typeof W.viewgraphid!=="undefined";}function L(W,X){W.viewgraphid=U.nodes.length;if(typeof X!=="undefined"){W.x=X.x;W.y=X.y;}U.nodes.push(W);
}function h(Y){var W,X=w.nodes.length;while(X--){if((W=w.nodes[X]).uniqId==Y){return W;}}return null;}function F(X){var W=h(X.uniqId);q(W);E();$.ajax({url:path+"/customerBehavior/relationClick",type:"POST",dataType:"json",data:{infoId:X.dataId,infoType:"11501",infoName:X.name},success:function(Y){},error:function(Y){return"error";
}});}function S(Z){$(".tip").show();var W=Z.type,ac=Z.dataId,ab={type:W,id:ac};var X=this,Y=document.querySelector(".tree");var aa=d3.mouse(Y);d3.select(X).attr("storke","#fff").attr("stroke-width","2px");
$(this).attr("transform","scale(1.2)");O(ab,Z,aa);}function V(W){d3.select(this).attr("storke","none").attr("stroke-width","2px");$(this).attr("transform","scale(1.0)");
}function Q(W){var X=1;d3.select(W).each(function(Y){if(Math.abs(W.width.baseVal.value-Y.width)<1){X/=C;}});K(W,X);}function K(W,X){d3.select(W).transition().attr("width",function(Y){return X*Y.width;
}).attr("height",function(Y){return X*Y.height;});}function E(){d.nodes(U.nodes).links(U.links).avoidOverlaps(true).convergenceThreshold(1e-9).handleDisconnected(true).start();
var X=j.selectAll(".link").data(U.links);X.enter().append("line").attr("class","link").attr("stroke",t.person).style("stroke-width",1);X.exit().remove();
var W=v.selectAll(".node").data(U.nodes,function(Z){return Z.viewgraphid;});W.exit().remove();var Y=W.enter().append("g").attr("class","node").on("mousedown",function(){k=true;
}).on("mouseup",function(){k=false;}).on("touchmove",function(){d3.event.preventDefault();}).call(d.drag);Y.append("svg:circle").attr("r",function(ab,Z){var aa=ab.type;
if(x==="project"){return B[aa];}else{if(x==="company"){return y[aa];}}}).attr("fill",function(aa,Z){return t[aa.type];}).on("mouseover",S).on("mouseout",V).on("click",function(aa,Z){F(aa);
});Y.append("svg:text").attr("dy","0.35em").on("click",function(aa,Z){F(aa);}).style("text-anchor","middle").style("fill","#fff").style("cursor","pointer").text(function(aa){var Z=aa.type;
if(Z==="project"){return"项目";}else{if(Z==="company"){return"单位";}else{if(Z==="person"){return"人";}}}}).style("font-size",function(aa){var Z=aa.type;if(Z==="project"){return"12px";
}else{if(Z==="company"){return"10px";}else{if(Z==="person"){return"8px";}}}});d.on("tick",function(){X.attr("x1",function(Z){return Z.source.x;}).attr("y1",function(Z){return Z.source.y;
}).attr("x2",function(Z){return Z.target.x;}).attr("y2",function(Z){return Z.target.y;});W.attr("transform",function(Z){return"translate("+Z.x+","+Z.y+")";
});});}A.init=function(W){d3.select(W.selector).selectAll("svg").remove();n=W.selector,p=W.series,t=W.colorSet,M=W.normal,J=W.legend,a=document.querySelector(n).getBoundingClientRect().width,e=document.querySelector(n).getBoundingClientRect().height,C=0.25,x=W.root,H=["项目","单位","人员"],c={project:"项目",company:"单位",person:"联系人"};
z=d3.scale.category20();d=u.d3adaptor().linkDistance(80).size([a,e]);f=d3.select(W.selector).append("svg").attr("width",a).attr("height",e).attr("pointer-events","all");
l=f.append("g").attr("class","legend").attr("transform","translate(10,20)");f.append("rect").attr("class","background").attr("fill","none").attr("width","100%").attr("height","100%").attr("cursor","move").call(d3.behavior.zoom().on("zoom",m));
R=f.append("g");k=false;j=R.append("g");v=R.append("g");N,w,U={nodes:[],links:[]};w=p;T=h("0");L(T);q(T);E();};g.exports=A;});