"use strict";define(function(i,P,g){var s=i("../../js/util/tool");var u=i("cola");var A={};var I=i("../../js/util/debounce");var n,p,t,M,J,a,e,x,B={project:25,company:20,person:15},y={project:20,company:25,person:15},C=0.25,H=["项目","单位","人员"],c={project:"项目",company:"单位",person:"联系人"},z,d,f,l,R,k=false,j,v,o,D;
var N,w,U,T;var r=0;function O(aa,Y,Z){var X=Y.type;$.ajax({url:path+"/getRelationDetail",type:"POST",dataType:"json",data:{type:aa.type,id:aa.id},success:function(ab){G(X,ab,Z,Y);
},error:function(ab){return"error";}});}function W(X,Z,Y){$.ajax({url:path+"/getRelevantInfo",type:"POST",dataType:"json",data:{name:X,id:Z},success:function(aa){if(Y){Y(aa);
}}});}function G(ae,Y,af,ad){var ae=ae;var Z=this;var X={company:"#0d62b9",project:"#f34046",person:"#e9920e"};var ac={project:"#fd5656",company:"#006bc8",person:"#f2a125"};
var ag={project:"#d63c41",company:"#0a8dff",person:"#cc861a"};var ab="";if(ae==="person"){ab="联系人";}else{if(ae==="project"){ab="项目";}else{if(ae==="company"){ab="单位";
}}}if($(".tip_project").hide()){$(".tip_project").show();}$(".tip_project").css("background",ac[ae]);$(".tip_project .tipWrap .more")[0].id=ae;$(".tip_project .tipTitle").css("borderColor",X[ae]);
$(".tip_project .tipCon").html("");$(".tip_project .tipTitle").html(ab).attr("title",Y.name);if(ae==="person"){var aa=$("<ul></ul>").append('<li class="info">姓 名：'+Y.name+"</li>").append('<li class="info">电 话：'+Y.cellphone+"</li>").appendTo($(".tip_project .tipCon"));
$(".tip_zhaobiao").hide();$(".tip_zhongbiao").hide();}else{if(ae==="company"){var aa=$("<ul></ul>").append('<li class="info">单位名称：'+Y.name+"</li>").appendTo($(".tip_project .tipCon"));
$(".tip_zhaobiao").hide();$(".tip_zhongbiao").hide();}else{if(ae==="project"){var aa=$("<ul></ul>").append('<li class="info">项目名称：'+Y.name+"</li>").appendTo($(".tip_project .tipCon"));
W(ad.name,ad.dataId,function(al){var an=al.zbxx,ah=al.zbgs,am,ak,aj=$(".tip_zhaobiao .tipCon ul li").eq(0),ai=$(".tip_zhongbiao .tipCon ul li").eq(0);ai.css("text-align","left");
aj.css("text-align","left");if(an.length===0){am="暂无信息";aj.css("text-align","center");}else{am=an[0]["title"];if(am.length>28){am=am.substr(0,28);}}if(ah.length===0){ak="暂无信息";
ai.css("text-align","center");}else{ak=ah[0]["title"];if(ak.length>28){ak=ak.substr(0,28);}}aj.html(am);ai.html(ak);});if($(".tip_zhaobiao").hide()){$(".tip_zhaobiao").slideDown(500);
}if($(".tip_zhongbiao").hide()){$(".tip_zhongbiao").slideDown(1000);}}}}$(".tip_project #project").find("a").attr("href",path+"/detail/"+Y.sourceId);}function m(){if(k){return;
}var X=d3.event.scale;R.attr("transform","translate("+d3.event.translate+") scale("+X+")");}function q(X){w.links.forEach(function(Y){var aa=w.nodes[Y.source],Z=w.nodes[Y.target];
if(aa===X&&!b(Z)){L(Z,X);}if(Z===X&&!b(aa)){L(aa,X);}});U.links=[];w.links.forEach(function(Y){var aa=w.nodes[Y.source],Z=w.nodes[Y.target];if(b(aa)&&b(Z)){U.links.push({source:aa,target:Z});
}});}function b(X){return typeof X.viewgraphid!=="undefined";}function L(X,Y){X.viewgraphid=U.nodes.length;if(typeof Y!=="undefined"){X.x=Y.x;X.y=Y.y;}U.nodes.push(X);
}function h(Z){var X,Y=w.nodes.length;while(Y--){if((X=w.nodes[Y]).uniqId==Z){return X;}}return null;}function F(Y){var X=h(Y.uniqId);q(X);E();$.ajax({url:path+"/customerBehavior/relationClick",type:"POST",dataType:"json",data:{infoId:Y.dataId,infoType:"11501",infoName:Y.name},success:function(Z){},error:function(Z){return"error";
}});}function S(aa){$(".tip_project").show();var X=aa.type,ad=aa.dataId,ac={type:X,id:ad};var Y=this,Z=document.querySelector(".tree");var ab=d3.mouse(Z);
$(this).attr("transform","scale(1.2)");O(ac,aa,ab);}function V(X){$(this).attr("transform","scale(1.0)");}function Q(X){var Y=1;d3.select(X).each(function(Z){if(Math.abs(X.width.baseVal.value-Z.width)<1){Y/=C;
}});K(X,Y);}function K(X,Y){d3.select(X).transition().attr("width",function(Z){return Y*Z.width;}).attr("height",function(Z){return Y*Z.height;});}function E(){d.nodes(U.nodes).links(U.links).avoidOverlaps(true).convergenceThreshold(1e-9).handleDisconnected(true).start();
var Y=j.selectAll(".link").data(U.links);Y.enter().append("line").attr("class","link").attr("stroke",t.person).style("stroke-width",1);Y.exit().remove();
var X=v.selectAll(".node").data(U.nodes,function(aa){return aa.viewgraphid;});X.exit().remove();var Z=X.enter().append("g").attr("class","node").on("mousedown",function(){k=true;
}).on("mouseup",function(){k=false;}).on("touchmove",function(){d3.event.preventDefault();}).call(d.drag);Z.append("svg:circle").attr("r",function(ac,aa){var ab=ac.type;
if(x==="project"){return B[ab];}else{if(x==="company"){return y[ab];}}}).attr("fill",function(ab,aa){return t[ab.type];}).on("mouseover",S).on("mouseout",V).on("click",function(ab,aa){F(ab);
});Z.append("svg:text").attr("dy","0.35em").on("click",function(ab,aa){F(ab);}).style("text-anchor","middle").style("fill","#fff").style("cursor","pointer").text(function(ab){var aa=ab.type;
if(aa==="project"){return"项目";}else{if(aa==="company"){return"单位";}else{if(aa==="person"){return"人";}}}}).style("font-size",function(ab){var aa=ab.type;
if(aa==="project"){return"12px";}else{if(aa==="company"){return"10px";}else{if(aa==="person"){return"8px";}}}});d.on("tick",function(){Y.attr("x1",function(aa){return aa.source.x;
}).attr("y1",function(aa){return aa.source.y;}).attr("x2",function(aa){return aa.target.x;}).attr("y2",function(aa){return aa.target.y;});X.attr("transform",function(aa){return"translate("+aa.x+","+aa.y+")";
});});}A.init=function(X){d3.select(X.selector).selectAll("svg").remove();n=X.selector,p=X.series,t=X.colorSet,M=X.normal,J=X.legend,a=document.querySelector(n).getBoundingClientRect().width,e=document.querySelector(n).getBoundingClientRect().height,C=0.25,x=X.root,H=["项目","单位","人员"],c={project:"项目",company:"单位",person:"联系人"};
z=d3.scale.category20();d=u.d3adaptor().linkDistance(80).size([a,e]);f=d3.select(X.selector).append("svg").attr("width",a).attr("height",e).attr("pointer-events","all");
l=f.append("g").attr("class","legend").attr("transform","translate(10,20)");f.append("rect").attr("class","background").attr("fill","none").attr("width","100%").attr("height","100%").attr("cursor","move").call(d3.behavior.zoom().on("zoom",m));
R=f.append("g");k=false;j=R.append("g");v=R.append("g");N,w,U={nodes:[],links:[]};w=p;T=h("0");L(T);q(T);E();};g.exports=A;});